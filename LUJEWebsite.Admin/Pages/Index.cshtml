@page
@using System.Collections;
@using LUJEWebsite.Library.Utils;
@using MySql.Data.MySqlClient;
@{
	HttpClient client = new HttpClient();
	ViewData["Title"] = "Peering Portal";
}

@try
{
	MySqlConnection luje_conn = new MySqlConnection(Configuration.DBPath);
	await luje_conn.OpenAsync();

	MySqlCommand luje_cmd = new MySqlCommand("select count(peering_ips.peering_ips_id) as count from peering_ips where peering_ips_active = false and peering_ips_rejected = false and peering_ips_deleted = false;", luje_conn);
	MySqlDataReader luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();

	string countApproval = "";
	if (await luje_rdr.ReadAsync())
	{
		countApproval = luje_rdr["count"].ToString();
	}
	await luje_rdr.CloseAsync();

	var ixList = new ArrayList();
	luje_cmd = new MySqlCommand("select distinct peeringdb_ix.name, peeringdb_ix.name_long, peeringdb_ixlan.id from peeringdb_network_ixlan inner join peeringdb_ixlan on peeringdb_network_ixlan.ixlan_id = peeringdb_ixlan.id inner join peeringdb_ix on peeringdb_ixlan.ix_id = peeringdb_ix.id where peeringdb_network_ixlan.asn = @portalowner and peeringdb_network_ixlan.status = 'ok';", luje_conn);
	luje_cmd.Parameters.AddWithValue("@portalowner", Convert.ToInt32(Configuration.PortalOwnerAsn));
	await luje_cmd.PrepareAsync();
	luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();
	while (await luje_rdr.ReadAsync())
	{
		var ix = new { name = luje_rdr["name"].ToString(), name_long = luje_rdr["name_long"].ToString(), id = luje_rdr["id"].ToString() };
		ixList.Add(ix);
	}
	await luje_rdr.CloseAsync();

	<div class="wrapper post">
		<main class="page-content" aria-label="Content">
			<article>
				<header class="header">
					<h1 class="header-title">Peering Admin</h1>
				</header>

				<div class="page-content">
					<h3>Approvals</h3>
					<p>There are @countApproval <a href="./peering_approvals">pending approvals</a></p>
					<h3>Manual action</h3>
					<p><a href="./peering_peers">Peers list</a></p>
					<ul>
						@foreach (dynamic ix in ixList)
						{
							if (string.IsNullOrEmpty(ix.name_long))
							{
								<li><a href="./peering_peers?ixlan=@ix.id">@ix.name</a></li>
							}
							else
							{
								<li><a href="./peering_peers?ixlan=@ix.id">@ix.name - @ix.name_long</a></li>
							}
						}
					</ul>
					<form method="get" action="./peering_network">
						<label for="asn">ASN</label>
						<input name="asn" type="number" /><br>
						<input type="submit" value="select" />
					</form>
				</div>
			</article>
		</main>
	</div>
	await luje_conn.CloseAsync();
}
catch (HttpRequestException e)
{
	Console.WriteLine("\nException Caught!");
	Console.WriteLine("Message :{0} ", e.Message);
}