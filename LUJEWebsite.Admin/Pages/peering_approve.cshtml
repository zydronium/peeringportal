@page
@using LUJEWebsite.Library.Utils;
@using MySql.Data.MySqlClient;
@{
	HttpClient client = new HttpClient();
	ViewData["Title"] = "Peering Portal";
	bool loggedin = false;
	bool admin = false;
	string accessToken = "";
}

@try
{
	string id = Request.Query["id"];
	string approve = Request.Query["approve"];

	MySqlConnection luje_conn = new MySqlConnection(Configuration.DBPath);
	await luje_conn.OpenAsync();

	MySqlCommand luje_cmd = new MySqlCommand("select peering.peering_id from peering_ips inner join peering on peering.peering_id = peering_ips.peering_ips_peering_id and peering.peering_deleted = false where peering_ips_active = false and peering_ips_rejected = false and peering_ips_deleted = false and peering_ips.peering_ips_id = @id;", luje_conn);
	luje_cmd.Parameters.AddWithValue("@id", Convert.ToInt32(id));
	await luje_cmd.PrepareAsync();
	MySqlDataReader luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();

	if(await luje_rdr.ReadAsync())
	{
		string peeringId = luje_rdr["peering_id"].ToString();
		if (approve == "y")
		{
			await luje_rdr.CloseAsync();
			luje_cmd = new MySqlCommand("update peering_ips set peering_ips_active = true, peering_ips_modified = NOW() where peering_ips_id = @id and peering_ips_deleted = false;", luje_conn);
			luje_cmd.Parameters.AddWithValue("@id", Convert.ToInt32(id));
			await luje_cmd.PrepareAsync();
			await luje_cmd.ExecuteNonQueryAsync();

			luje_cmd = new MySqlCommand("update peering set peering_active = true, peering_modified = NOW() where peering_id = @id and peering_deleted = false;", luje_conn);
			luje_cmd.Parameters.AddWithValue("@id", Convert.ToInt32(peeringId));
			await luje_cmd.PrepareAsync();
			await luje_cmd.ExecuteNonQueryAsync();
		}
		else
		{
			await luje_rdr.CloseAsync();
			luje_cmd = new MySqlCommand("update peering_ips set peering_ips_rejected = true, peering_ips_modified = NOW() where peering_ips_id = @id and peering_ips_deleted = false;", luje_conn);
			luje_cmd.Parameters.AddWithValue("@id", Convert.ToInt32(id));
			await luje_cmd.PrepareAsync();
			await luje_cmd.ExecuteNonQueryAsync();

			luje_cmd = new MySqlCommand("select peering.peering_id from peering_ips inner join peering on peering.peering_id = peering_ips.peering_ips_peering_id and peering.peering_deleted = false where peering_ips_deleted = false and peering_ips_rejected = false and peering.peering_id = @id;", luje_conn);
			luje_cmd.Parameters.AddWithValue("@id", Convert.ToInt32(peeringId));
			await luje_cmd.PrepareAsync();
			luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();

			if (!await luje_rdr.ReadAsync())
			{
				await luje_rdr.CloseAsync();
				luje_cmd = new MySqlCommand("update peering set peering_deleted = true, peering_modified = NOW() where peering_id = @id and peering_deleted = false;", luje_conn);
				luje_cmd.Parameters.AddWithValue("@id", Convert.ToInt32(peeringId));
				await luje_cmd.PrepareAsync();
				await luje_cmd.ExecuteNonQueryAsync();
			}
			else
			{
				await luje_rdr.CloseAsync();
			}
		}
	}

	await luje_conn.CloseAsync();
	Response.Redirect("./peering_approvals");
}
catch (HttpRequestException e)
{
	Console.WriteLine("\nException Caught!");
	Console.WriteLine("Message :{0} ", e.Message);
}