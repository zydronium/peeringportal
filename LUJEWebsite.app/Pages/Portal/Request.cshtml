@page
@using LUJEWebsite.Library.Utils
@using Newtonsoft.Json.Linq;
@using LUJEWebsite.app.Extentions;
@using LUJEWebsite.Library.Models;
@using MySql.Data.MySqlClient;
@using System.Collections;
@{
	HttpClient client = new HttpClient();
	ViewData["Title"] = "Peering Portal";
	bool loggedin = false;
	bool admin = false;
	string accessToken = "";
	string lanid = "";
	string addrid = "";
	string oaddrid = "";
	string addrv = "";
	Network selectedNetwork = null;
	if (HttpContext.Session.Get<Boolean>("loggedin") != null && HttpContext.Session.Get<Boolean>("loggedin") == true)
	{
		string asn = HttpContext.Request.Query["asn"];
		if (asn != "")
		{
			Profile profile = HttpContext.Session.Get<Profile>("profile");
			foreach (Network network in profile.networks)
			{
				if (network.asn.ToString() == asn)
				{
					selectedNetwork = network;
					loggedin = true;
				}
			}
		}
		addrid = HttpContext.Request.Query["addrid"];
		if (addrid == "")
		{
			Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
			return;

		}
		oaddrid = HttpContext.Request.Query["oaddrid"];
		if (oaddrid == "")

		{

			Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);

			return;

		}
		addrv = HttpContext.Request.Query["v"];
		if (addrv != "4" && addrv != "6")
		{
			Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
			return;
		}
		lanid = HttpContext.Request.Query["lanid"];
		if (lanid == "")
		{
			Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
			return;
		}
	}
	if (HttpContext.Session.Get<Boolean>("admin") != null && HttpContext.Session.Get<Boolean>("admin") == true)
	{
		admin = true;
	}

	@if (!loggedin)
	{
		Response.Redirect("/portal/");
	}
	else
	{
		try
		{
			Profile profile = HttpContext.Session.Get<Profile>("profile");
			string asn = "AS" + selectedNetwork.asn;
			MySqlConnection luje_conn = new MySqlConnection(Configuration.DBPath);
			luje_conn.Open();

			MySqlCommand luje_cmd = new MySqlCommand("select peeringdb_network_ixlan.ixlan_id, peeringdb_network_ixlan.ipaddr4, peeringdb_network_ixlan.ipaddr6 from peeringdb_network_ixlan where asn = @portalowner and ixlan_id = @lanid and id = @oaddrid and status = 'ok';", luje_conn);
			luje_cmd.Parameters.AddWithValue("@portalowner", Convert.ToInt32(Configuration.PortalOwnerAsn));
			luje_cmd.Parameters.AddWithValue("@lanid", Convert.ToInt32(lanid));
			luje_cmd.Parameters.AddWithValue("@oaddrid", Convert.ToInt32(oaddrid));
			await luje_cmd.PrepareAsync();
			MySqlDataReader luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();
			if (luje_rdr.Read())
			{
				if (addrv == "4" && luje_rdr["ipaddr4"] == null)
				{
					Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
					luje_rdr.Close();
					luje_conn.Close();
					return;
				}
				if (addrv == "6" && luje_rdr["ipaddr6"] == null)
				{
					Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
					luje_rdr.Close();
					luje_conn.Close();
					return;
				}
				luje_rdr.Close();
			}
			else
			{
				Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
				await luje_conn.CloseAsync();
				return;
			}

			luje_cmd = new MySqlCommand("select peeringdb_network_ixlan.id, peeringdb_ix.name, peeringdb_network_ixlan.net_id, peeringdb_network_ixlan.ixlan_id, peeringdb_network_ixlan.ipaddr4, peeringdb_network_ixlan.ipaddr6, peeringdb_network.irr_as_set from peeringdb_network_ixlan inner join peeringdb_network on peeringdb_network.id = peeringdb_network_ixlan.net_id and peeringdb_network.status = 'ok' inner join peeringdb_ixlan on peeringdb_ixlan.id = peeringdb_network_ixlan.ixlan_id inner join peeringdb_ix on peeringdb_ix.id = peeringdb_ixlan.ix_id where peeringdb_network_ixlan.asn = @asn and peeringdb_network_ixlan.id = @id and peeringdb_network_ixlan.ixlan_id = @lanid and peeringdb_network_ixlan.status = 'ok';", luje_conn);
			luje_cmd.Parameters.AddWithValue("@asn", selectedNetwork.asn);
			luje_cmd.Parameters.AddWithValue("@id", Convert.ToInt32(addrid));
			luje_cmd.Parameters.AddWithValue("@lanid", Convert.ToInt32(lanid));
			await luje_cmd.PrepareAsync();
			luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();
			string address = "";
			string netid = "";
			string asset = "";

			if (await luje_rdr.ReadAsync())
			{
				if (addrv == "4" && luje_rdr["ipaddr4"] == null)
				{
					Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
					luje_rdr.Close();
					luje_conn.Close();
					return;
				}
				if (addrv == "6" && luje_rdr["ipaddr6"] == null)
				{
					Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
					luje_rdr.Close();
					luje_conn.Close();
					return;
				}
				if (addrv == "4")
				{
					address = luje_rdr["ipaddr4"].ToString();
				}
				if (addrv == "6")
				{
					address = luje_rdr["ipaddr6"].ToString();
				}
				netid = luje_rdr["net_id"].ToString();
				if (luje_rdr["irr_as_set"].ToString() != "")
				{
					asset = luje_rdr["irr_as_set"].ToString();
					String[] spearator = { "::" };
					String[] assetlist = asset.Split(spearator,StringSplitOptions.RemoveEmptyEntries);
					if (assetlist.Count() == 1)
					{
						asset = assetlist[0];
					}
					else
					{
						asset = assetlist[1];
					}
				}
				else
				{
					asset = "AS" + selectedNetwork.asn;
				}

				luje_rdr.Close();
			}
			else
			{
				Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
				await luje_conn.CloseAsync();
				return;
			}

			luje_cmd = new MySqlCommand("select peering_id from peering where peering_peeringdb_id = @peeringdb_id and peering_deleted = false;", luje_conn);
			luje_cmd.Parameters.AddWithValue("@peeringdb_id", selectedNetwork.id);
			await luje_cmd.PrepareAsync();
			luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();

			string peering_id = "";

			if (await luje_rdr.ReadAsync())
			{
				peering_id = luje_rdr["peering_id"].ToString();
				await luje_rdr.CloseAsync();
			}
			else
			{
				await luje_rdr.CloseAsync();
				luje_cmd = new MySqlCommand("insert into peering (peering_peeringdb_id, peering_name, peering_as_set, peering_asn, peering_active, peering_aspa_upstream, peering_deployed, peering_created, peering_modified, peering_deleted) values(@peeringdb_id, @name, @asset, @asn, false, true, false, NOW(), NOW(), false);", luje_conn);
				luje_cmd.Parameters.AddWithValue("@peeringdb_id", selectedNetwork.id);
				luje_cmd.Parameters.AddWithValue("@name", selectedNetwork.name);
				luje_cmd.Parameters.AddWithValue("@asset", asset);
				luje_cmd.Parameters.AddWithValue("@asn", selectedNetwork.asn);
				await luje_cmd.PrepareAsync();
				await luje_cmd.ExecuteNonQueryAsync();

				luje_cmd = new MySqlCommand("select peering_id from peering where peering_peeringdb_id = @peeringdb_id and peering_deleted = false;", luje_conn);
				luje_cmd.Parameters.AddWithValue("@peeringdb_id", selectedNetwork.id);
				await luje_cmd.PrepareAsync();
				luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();
				if (await luje_rdr.ReadAsync())
				{
					peering_id = luje_rdr["peering_id"].ToString();
				}
				await luje_rdr.CloseAsync();
			}


			luje_cmd = new MySqlCommand("select peering_ips_active, peering_ips_deployed from peering_ips inner join peering on peering.peering_id = peering_ips_peering_id and peering_deleted = false where peering_ips_peeringdb_lanid = @lanid and peering_ips_peeringdb_addrid = @addrid and peering_ips_peeringdb_oaddrid = @oaddrid and peering_ips_type = @type and peering_peeringdb_id = @peeringdb_id and peering_ips_deleted = false;", luje_conn);
			luje_cmd.Parameters.AddWithValue("@peeringdb_id", selectedNetwork.id);
			luje_cmd.Parameters.AddWithValue("@addrid", Convert.ToInt32(addrid));
			luje_cmd.Parameters.AddWithValue("@oaddrid", Convert.ToInt32(oaddrid));
			luje_cmd.Parameters.AddWithValue("@lanid", Convert.ToInt32(lanid));
			luje_cmd.Parameters.AddWithValue("@type", Convert.ToInt32(addrv));
			await luje_cmd.PrepareAsync();
			luje_rdr = (MySqlDataReader)await luje_cmd.ExecuteReaderAsync();

			if (await luje_rdr.ReadAsync())
			{
				await luje_rdr.CloseAsync();
			}
			else
			{
				await luje_rdr.CloseAsync();
				luje_cmd = new MySqlCommand("insert into peering_ips (peering_ips_request_id, peering_ips_peering_id, peering_ips_peeringdb_lanid, peering_ips_peeringdb_addrid, peering_ips_peeringdb_oaddrid, peering_ips_type, peering_ips_addr, peering_ips_active, peering_ips_rejected, peering_ips_deployed, peering_ips_notified, peering_ips_notified_skip, peering_ips_notified_approval, peering_ips_notified_email, peering_ips_created, peering_ips_modified, peering_ips_deleted) values(@request_id, @peering_id, @lanid, @addrid, @oaddrid, @type, @addr, false, false, false, false, false, false, @email, NOW(), NOW(), false);", luje_conn);
				luje_cmd.Parameters.AddWithValue("@request_id", Guid.NewGuid());
				luje_cmd.Parameters.AddWithValue("@peering_id", Convert.ToInt32(peering_id));
				luje_cmd.Parameters.AddWithValue("@lanid", Convert.ToInt32(lanid));
				luje_cmd.Parameters.AddWithValue("@addrid", Convert.ToInt32(addrid));
				luje_cmd.Parameters.AddWithValue("@oaddrid", Convert.ToInt32(oaddrid));
				luje_cmd.Parameters.AddWithValue("@type", Convert.ToInt32(addrv));
				luje_cmd.Parameters.AddWithValue("@addr", address);
				luje_cmd.Parameters.AddWithValue("@email", profile.email);
				await luje_cmd.PrepareAsync();
				await luje_cmd.ExecuteNonQueryAsync();
			}

			Response.Redirect("/portal/network?asn=" + selectedNetwork.asn);
			await luje_conn.CloseAsync();
		}
		catch (HttpRequestException e)
		{
			Console.WriteLine("\nException Caught!");
			Console.WriteLine("Message :{0} ", e.Message);
		}
	}
}